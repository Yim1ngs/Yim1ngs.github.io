<!DOCTYPE html><html lang="en" theme-mode="dark"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>CVE-2024-50379-Tomcat-rce | Hexo</title><link rel="icon" type="image/x-icon" href="/favicon.ico"><link rel="preload" as="font" crossorigin="anonymous" href="/font/Bender.ttf"><link rel="preload" as="font" crossorigin="anonymous" href="/font/BenderLight.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/font/JetBrainsMono-Regular.woff2"><link rel="stylesheet" href="/css/arknights.css"><style>@font-face {
  font-family: Bender;
  src: local('Bender'), url("/font/Bender.ttf"), url("/font/Bender.otf");
}
@font-face {
  font-family: BenderLight;
  src: local('BenderLight'), url("/font/BenderLight.ttf");
}
@font-face {
  font-family: 'JetBrains Mono';
  src: local('JetBrains Mono'), url('/font/JetBrainsMono-Regular.woff2') format('woff2');
}
</style><script>var config = {"root":"/","code_fold":15,"search":{"preload":false,"activeHolder":"Enter here","blurHolder":"Search","noResult":"Data \"$0\" not found"},"code":{"codeInfo":"$0 - $1 lines","copy":"copy"}}</script><link type="text/css" rel="stylesheet" href="/lib/encrypt/hbe.style.css"><script src="//unpkg.com/mermaid@10.5.0/dist/mermaid.min.js"></script><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lightgallery.css"><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lg-zoom.css"><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lg-thumbnail.css"><link type="text/css" rel="stylesheet" href="/lib/fontawesome/css/all.min.css"><script>if (window.localStorage.getItem('theme-mode') === 'light')
 document.documentElement.setAttribute('theme-mode', 'light')
if (window.localStorage.getItem('theme-mode') === 'dark')
 document.documentElement.setAttribute('theme-mode', 'dark')</script><style>@font-face {
 font-family: BenderLight;
 src: local('Bender'), url("/font/BenderLight.woff2") format('woff2');
}
@font-face {
 font-family: 'JetBrains Mono';
 src: local('JetBrains Mono'), url('/font/JetBrainsMono-Regular.woff2') format('woff2');
}</style><style>:root {
 --dark-background: url('https://ak.hypergryph.com/assets/index/images/ak/pc/bk.jpg');
 --light-background: url('/img/bk.jpg');
 --theme-encrypt-confirm: 'confirm'
}</style><script defer src="/js/arknights.js"></script><script defer src="/js/search.js"></script><script defer type="module">import mermaid from '//unpkg.com/mermaid@10.5.0/dist/mermaid.esm.mjs';
window.mermaid = mermaid;
code.paintMermaid();
</script><script async src="//unpkg.com/lightgallery@2.7.1/lightgallery.min.js"></script><script async src="//unpkg.com/lightgallery@2.7.1/plugins/zoom/lg-zoom.min.js"></script><script async src="//unpkg.com/lightgallery@2.7.1/plugins/thumbnail/lg-thumbnail.min.js"></script><script async src="/lib/encrypt/hbe.js"></script><script async src="/js/pjax.js"></script><script class="pjax-js">reset= () => {document.querySelector('.lg-container')?.remove()
lightGallery(document.getElementById('post-bg'), {
  plugins: [lgZoom,lgThumbnail],
  selector: '.item-img'})}</script><script>window.addEventListener("load",() => {pjax = new Pjax({
 cacheBust: false,
 selectors: ['title','article','#aside-block','.pjax-js','data-pjax','.busuanzi'],
 switches: {'article': Pjax.switches.sideBySide},
 switchesOptions: {
   'article': {
     classNames: {
       remove: "pjax-out",
       add: "pjax-in"
     }
   }
 }
});
document.addEventListener("pjax:complete", reset);reset()})</script><script class="pjax-js">reset= () => {document.querySelector('.lg-container')?.remove()
lightGallery(document.getElementById('post-bg'), {
  plugins: [lgZoom,lgThumbnail],
  selector: '.item-img'})}</script><script>window.addEventListener("load",() => {pjax = new Pjax({
 cacheBust: false,
 selectors: ['title','article','#aside-block','.pjax-js'],
 switches: {'article': Pjax.switches.sideBySide},
 switchesOptions: {
   'article': {
     classNames: {
       remove: "pjax-out",
       add: "pjax-in"
     }
   }
 }
});
document.addEventListener("pjax:complete", reset);reset()})</script><meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
</head><body><div class="loading" style="opacity: 0;"><div class="loadingBar left"></div><div class="loadingBar right"></div></div><main><header class="closed"><div class="navBtn"><i class="navBtnIcon"><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span></i></div><nav><div class="navItem" id="search-header"><span class="navItemTitle"><input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="Search" spellcheck="false" maxlength="50" type="text" id="search-input"></span></div><div class="navItem" id="search-holder"></div><div class="search-popup" tabindex="0"><div id="search-result"></div></div><ol class="navContent"><li class="navItem"><a class="navBlock" href="/"><span class="navItemTitle">Home</span></a></li><li class="navItem" matchdata="categories,tags"><a class="navBlock" href="/archives/"><span class="navItemTitle">Archives</span></a></li></ol></nav></header><article><div id="post-bg"><div id="post-title"><h1>CVE-2024-50379-Tomcat-rce</h1><div id="post-info"><span>First Post: <div class="control"><time datetime="2025-04-22T11:53:31.000Z" id="date"> 2025-04-22</time></div></span><br><span>Last Update: <div class="control"><time datetime="2025-04-23T08:42:30.221Z" id="updated"> 2025-04-23</time></div></span></div></div><hr><div id="post-content"><h1 id="CVE-2024-50379-Tomcat-rce"><a href="#CVE-2024-50379-Tomcat-rce" class="headerlink" title="CVE-2024-50379-Tomcat-rce"></a>CVE-2024-50379-Tomcat-rce</h1><p>🤔 此漏洞有个前生 <strong>CVE-2017-12615</strong></p>
<p>在 Apache Tomcat 7.0.0 - 7.0.79 范围中，如果 web.xml 文件中，readonly 被设置成 false，我们就能用 put 方法(前提是没被禁用)上传一个精心打造的 jsp 文件直接来达到上传 webshell 的目的，简单粗暴</p>
<p><del>不是本次重点，不多述</del></p>
<p><strong>接下来是复现部分</strong> ：</p>
<h3 id="环境："><a href="#环境：" class="headerlink" title="环境："></a>环境：</h3><p>首先我们需要 windows 环境，只有对大小不敏感的系统才能成功 rce</p>
<p>受影响的 Apache Tomcat 版本包括：</p>
<ul>
<li>11.0.0-M1 &lt;&#x3D; Apache Tomcat &lt; 11.0.2</li>
<li>10.1.0-M1 &lt;&#x3D; Apache Tomcat &lt; 10.1.34</li>
<li>9.0.0.M1 &lt;&#x3D; Apache Tomcat &lt; 9.0.98()</li>
</ul>
<h3 id="复现："><a href="#复现：" class="headerlink" title="复现："></a>复现：</h3><p>下载有洞的版本后，我们需要先设置其中的 web.xml，在其中添加一个参数</p>
<p><img src="https://raw.githubusercontent.com/Yim1ngs/images/refs/heads/main/static/Q7IabkGKyoBkmjxDtCycFrIXnbb.png"></p>
<p>将 readonly 指定为 false，这样才能让 defultServlet 允许上传文件到服务器</p>
<p>然后直接点击 startup.bat 启动，这里可能会编码错误，因为 windows 一般使用 GBK，我们需要在 logging.properties 文件中修改一下编码方式</p>
<p><img src="https://raw.githubusercontent.com/Yim1ngs/images/refs/heads/main/static/VihvbHoT0ozf5gxsxaCcAap0ndf.png"></p>
<p>直接双击 startup.bat 启动</p>
<p><img src="https://raw.githubusercontent.com/Yim1ngs/images/refs/heads/main/static/KNWZbwB32oKb2hxA04mcb4NjnJf.png"></p>
<p>卡在这也没事，直接访问本地的 8080 端口，即可</p>
<p>当我们尝试将一个 a.jsp 文件上传的时候，会发现 404 错误、</p>
<p>Tomcat 是禁止直接上传 <code>.jsp</code> 文件，后缀为小写的 <code>.jsp</code> 文件，当用户访问时，Tomcat 会交给 jspServlet 处理，而他并不处理 put 方法，导致上传失败。</p>
<p><img src="https://raw.githubusercontent.com/Yim1ngs/images/refs/heads/main/static/XStAbYe3eoyCuCxD6Fuc1nEbnVh.png"></p>
<p>所以我们需要先让文件能被 put 上去，我们选择将文件改为 a.Jsp 这样处理他的就是 defaultsevrlet，文件可以顺利上传</p>
<p><img src="https://raw.githubusercontent.com/Yim1ngs/images/refs/heads/main/static/GNHJb98HwoXVD9xxCtXc5819nad.png"></p>
<p>回应 201(即上传成功)，本地也能看见</p>
<p><img src="https://raw.githubusercontent.com/Yim1ngs/images/refs/heads/main/static/EgD7bcMFdoAsstx9gUKcBVtUnZd.png"></p>
<p>（这时候应该可以写个 webshell，用蚁剑直接连上（没试过</p>
<p>但显然我们可以做的更多，接下来进行 rce</p>
<p>这时候，如果我们的文件中有精心构造的内容，我们如何让他执行呢</p>
<p>（本来我是使用 yakit 开启多个线程，一个不断 put .Jsp 文件，另一个不断 GET .jsp 文件来实现条件竞争达成 rce，但是一直不成功，这里使用佬佬的 poc 完成 rce</p>
<p>工具作者的 github 地址：<a target="_blank" rel="noopener" href="https://github.com/SleepingBag945/CVE-2024-50379">https://github.com/SleepingBag945/CVE-2024-50379</a></p>
<p><img src="https://raw.githubusercontent.com/Yim1ngs/images/refs/heads/main/static/DwhSb1Si4oA2JQx90elcyh8Pnoh.png"></p>
<p>当我们访问地址时，成功弹出了计算器</p>
<p><img src="https://raw.githubusercontent.com/Yim1ngs/images/refs/heads/main/static/OuXEbYEqNomCOPxFdTicpfGinCh.png"></p>
<h3 id="工具源码分析："><a href="#工具源码分析：" class="headerlink" title="工具源码分析："></a>工具源码分析：</h3><p><del>自己看</del></p>
<p>主要在 main 函数中，通过开启三个线程，两个不断 put，一个 get，重复到成功</p>
<h3 id="原理解释："><a href="#原理解释：" class="headerlink" title="原理解释："></a>原理解释：</h3><p>对于 win 来说，a.Jsp 和 a.jsp 是一个文件（这个也可以研究 windows 找源码的方法知道为什么，这里不多解释。</p>
<p>我们要在 GET a.jsp 时让 JspServlet 执行这个文件，这里涉及 AbstractFileResourceSet 的 file 方法</p>
<pre><code>try &#123;
    // JRE 方法
    canPath = file.getCanonicalPath();
    &#125; catch (IOException var6) &#123;
    &#125;

if (canPath != null &amp;&amp; canPath.startsWith(this.canonicalBase)) &#123;
    String absPath = this.normalize(file.getAbsolutePath());
    ....
    if (!canPath.equals(absPath)) &#123;
        if (!canPath.equalsIgnoreCase(absPath)) &#123;
            this.logIgnoredSymlink(this.getRoot().getContext().getName(), absPath, canPath);&#125;
            return null;
        &#125; else &#123;
            return file;
         &#125;
 //大概就这些
</code></pre>
<p>我们发现只有当 abspath&#x3D;canpath 时才会返回文件，也就是才会执行代码</p>
<p>其中 abs path 是用户输入的路径拼接处理后的本地绝对路径</p>
<p>其中 can path 是 JRE 类 WinNTFileSystem JNI&#x2F;cache 处理后得到的路径（如果缓存启用就会从其中获取</p>
<p>当我们 PUT 一个 a.Jsp 文件上去时，显然 abspath 和 canpath 都是 a.Jsp</p>
<p>当我们 GET a.jsp 时，如果我们已经 PUT a.Jsp，那么，abspath 会是 a.jsp canpath 会是 a.Jsp(从缓存中读)，那么不通过检测，就不会返回文件而如果我们 PUT 的 a.Jsp 还没落地 那么 abspath canpath 都会是 a.jsp 这样会返回文件</p>
<p>但很显然不 PUT 就不会有文件，而我们查看代码可以知道，这种检查不会只有一次而是重复好几次</p>
<pre><code>org.apache.catalina.webresources#getResource
cacheEntry.validateResource(useClassLoaderResources);
//在 JspServlet 后续处理的过程中，会再次抵达 AbstractFileResourceSet file 方法
//类似的过程会重复好几次
</code></pre>
<p>在 JspServlet 读取文件前会经过很多次的检查</p>
<p>所以，我们要保证在它检查的时候，我们的 abspath canpath 要一直保持 a.jsp 而在返回文件前一刻，我们的 PUT a.Jsp 文件要刚好落地，这样才能完美执行，这里就是一个条件竞争</p>
<div id="paginator"></div></div><div id="post-footer"><div id="pages"><div class="footer-link" style="width: 50%;text-align:right;border-right:1px #fe2 solid"><a href="/2025/07/17/java%E5%AE%89%E5%85%A8%E5%AD%A6%E4%B9%A0%E7%AF%87-1-%E5%8F%8D%E5%B0%84/">← Next java安全学习篇:1-反射</a></div><div class="footer-link" style="width: 50%;right:1px;border-left:1px #fe2 solid"><a href="/2025/04/02/%E6%9D%82%E6%8A%80%EF%BC%81/">杂技！ Prev →</a></div></div></div></div><div class="bottom-btn"><div><a class="i-top" id="to-top" onClick="scrolls.scrolltop();" title="To Top" style="opacity: 0; display: none;">∧ </a><a class="i-index" id="to-index" href="#toc-div" title="To Catalog">≡</a><a class="i-color" id="color-mode" onClick="colorMode.change()" title="Change Theme"></a><a onclick="BgmControl()"><svg id="bgm-control" viewBox="0 0 30 34" fill="#18d1ff" style="width: 24px; transition: transform .3s;margin-top: 4px"><path d="M25.998 23.422V11.29h3.999v12.132h-3.999zM19.497 6.234h4.001v22.243h-4.001V6.234zM12.998.867h4v32.978h-4V.867zm-6.5 5.367h4.001v22.243H6.498V6.234zm-6.5 5.056h4v12.132h-4V11.29z"></path></svg><audio id="bgm" src="/audio/bgm.mp3" autoplay loop crossorigin="anonymous"> </audio></a></div></div></article><aside><div id="about"><a href="/" id="logo"><img src="https://ak.hypergryph.com/assets/index/images/ak/pc/faction/1.png" alt="Logo" style="margin:0;border-radius:0;"></a><h1 id="Dr"><a href="/">Yim1ngs</a></h1><div id="description"><p></p></div></div><div id="aside-block"><div id="toc-div"><h1>Catalog</h1><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#CVE-2024-50379-Tomcat-rce"><span class="toc-number">1.</span> <span class="toc-text">CVE-2024-50379-Tomcat-rce</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%EF%BC%9A"><span class="toc-number">1.0.1.</span> <span class="toc-text">环境：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%8D%E7%8E%B0%EF%BC%9A"><span class="toc-number">1.0.2.</span> <span class="toc-text">复现：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B7%A5%E5%85%B7%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%EF%BC%9A"><span class="toc-number">1.0.3.</span> <span class="toc-text">工具源码分析：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%9F%E7%90%86%E8%A7%A3%E9%87%8A%EF%BC%9A"><span class="toc-number">1.0.4.</span> <span class="toc-text">原理解释：</span></a></li></ol></li></ol></li></ol></div></div><footer><nobr>Published with <a target="_blank" rel="noopener" href="http://hexo.io">Hexo</a></nobr><wbr><nobr> Theme <a target="_blank" rel="noopener" href="https://github.com/Yue-plus/hexo-theme-arknights">Arknights</a></nobr><wbr><nobr> by <a target="_blank" rel="noopener" href="https://github.com/Yue-plus">Yue_plus</a></nobr></footer></aside></main><canvas id="canvas-dust"></canvas></body></html>